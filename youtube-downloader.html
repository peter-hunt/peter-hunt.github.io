<!DOCTYPE html>
<html>

<head>
    <title>Peter's YouTube Downloader</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>Peter's YouTube Downloader</h1>

    <center>
        <h4>Please put the ID of the video you are downloading at the box below.</h4>
        <h4><code>"XXXXXXXXXXX"</code> would be the id of
            <code>"https://www.youtube.com/watch?v=XXXXXXXXXXX"</code>
        </h4>

        <input id="get-url" type="text" placeholder="Please enter the video ID here" style="font-size: 32px" value="">

        <button class="button get" onclick="Get()">Get</button>
        <br>

        <h3 id="alert" style="color: #F7005E"><br></h3>

        <iframe id="preview" width="800" height="600" src="https://www.youtube.com/embed/"></iframe>

        <button class="button get" onclick="Download()">Download</button>

        <h4>Go back to the <a href="https://peter-hunt.github.io">Home Page</a></h4>

        <script>
            function Download() {
                const express = require('express');
                const cors = require('cors');
                const ytdl = require('ytdl-core');
                const app = express();

                app.use(cors);

                app.listen(4000, () => {
                    console.log('Server Works !!! At port 4000');
                });

                app.get('/download', (req, res) => {
                    var URL = req.query.URL;
                    res.header('Content-Disposition', 'attachment; filename="video.mp4"');
                    ytdl(URL, {
                        format: 'mp4'
                    }).pipe(res);
                });

                var url = document.getElementById("get-url").value;

                console.log(`URL: ${url}`);
                sendURL(url);

                function sendURL(URL) {
                    window.location.href = `http://localhost:4000/download?URL=${URL}`;
                }
            }
        </script>

        <script>
            function parse_query_string(query) {
                var vars = query.split("&");
                var query_string = {};
                for (var i = 0; i < vars.length; i++) {
                    var pair = vars[i].split("=");
                    var key = decodeURIComponent(pair[0]);
                    var value = decodeURIComponent(pair[1]);
                    // If first entry with this name
                    if (typeof query_string[key] === "undefined") {
                        query_string[key] = decodeURIComponent(value);
                        // If second entry with this name
                    } else if (typeof query_string[key] === "string") {
                        var arr = [query_string[key], decodeURIComponent(value)];
                        query_string[key] = arr;
                        // If third or later entry with this name
                    } else {
                        query_string[key].push(decodeURIComponent(value));
                    }
                }
                return query_string;
            }

            var query = window.location.search.substring(1);
            var query_object = parse_query_string(query);
            var url = query_object.url;
            if (url === undefined) {
                document.getElementById("get-url").value = "";
            } else {
                document.getElementById("get-url").value = url;
            }

            document.getElementById("preview").src = "https://www.youtube.com/embed/" + url + "?rel=0&fs=0";

            function Get() {
                var url = document.getElementById("get-url").value;
                if (url.match(/^[A-Za-z\d\-]{11}$/)) {
                    window.open("youtube-downloader.html?url=" + url, "_self");
                    document.getElementById("alert").innerHTML = "";
                } else {
                    document.getElementById("alert").innerHTML =
                        "Invalid Video ID";
                }
            }
        </script>
    </center>
</body>

</html>